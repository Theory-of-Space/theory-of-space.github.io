---
// ActiveExplorationSession.astro - RAGEN-style active exploration session
const rawBase = import.meta.env.BASE_URL ?? '/';
const normalizedBase = rawBase.endsWith('/') ? rawBase : `${rawBase}/`;
const resolveAssetPath = (path) => {
  if (!path) return '';
  if (/^https?:\/\//.test(path)) return path;
  const trimmed = path.replace(/^\//, '');
  return `${normalizedBase}${trimmed}`;
};
---
<section id="active-exploration" class="content-section">
  <div class="section-container">
    <h4 class="section-title" style="font-size: 1.6rem; opacity: 0.8; margin-bottom: 0.5rem;">Active Exploration Example</h4>
    <p class="section-description">
      Step through the agent's interaction to see what it observes, chooses, believes, and how that aligns with the ground truth.
    </p>

    <div class="ae-session-card">

      <div class="ae-steps-panel">
        <div class="ae-steps-top">
          <div class="ae-steps-label">Steps</div>
          <div class="ae-steps-count ae-steps-count-top">
            <span id="ae-current-step-top">0</span> / <span id="ae-total-steps-top">6</span>
          </div>
        </div>
        <input
          id="ae-step-slider"
          class="ae-step-slider"
          type="range"
          min="0"
          max="6"
          value="0"
          step="1"
          aria-label="Step progress"
        />
        <div class="ae-steps-controls">
          <button id="ae-prev-step" class="ae-step-button" aria-label="Previous step">
            <svg viewBox="0 0 24 24" width="48" height="48" aria-hidden="true">
              <polyline points="15 18 9 12 15 6"></polyline>
            </svg>
          </button>
          <div class="ae-steps-count">
            Step <span id="ae-current-step-mid">0</span> of <span id="ae-total-steps-mid">6</span>
          </div>
          <button id="ae-next-step" class="ae-step-button" aria-label="Next step">
            <svg viewBox="0 0 24 24" width="48" height="48" aria-hidden="true">
              <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
          </button>
          <button id="ae-play-pause" class="ae-step-button" aria-label="Play steps">
            <svg class="ae-play-icon" viewBox="0 0 24 24" width="48" height="48" aria-hidden="true">
              <polygon points="8 5 19 12 8 19"></polygon>
            </svg>
            <svg class="ae-pause-icon" viewBox="0 0 24 24" width="48" height="48" aria-hidden="true">
              <rect x="7" y="5" width="4" height="14"></rect>
              <rect x="13" y="5" width="4" height="14"></rect>
            </svg>
          </button>
        </div>
      </div>

      <div class="ae-session-grid">
        <div class="ae-content-grid">
          <div class="ae-column">
            <div class="ae-card ae-action-card">
              <div class="ae-card-title">Agent Action</div>
              <div class="ae-action-line">
                <img class="ae-action-icon" src={resolveAssetPath('/exploration_example/agent_icon.png')} alt="Agent icon" />
                <span class="ae-action-colon">ï¼š</span>
                <p id="ae-action-text" class="ae-card-text ae-action-text-enhanced ae-fade-target">Move forward to inspect the door.</p>
              </div>
            </div>

            <div class="ae-card ae-observation-card">
              <div class="ae-card-title">Observation</div>
              <div class="ae-observation-body ae-observation-stack">
                <!-- Vision World -->
                <div class="ae-obs-section">
                   <div class="ae-obs-label">Vision World</div>
                   <div class="ae-observation-image-container">
                     <img id="ae-observation-image" class="ae-fade-target" src="" alt="Observation view" />
                     <div id="ae-vision-no-obs" class="ae-no-obs-text" style="display: none;">No observation</div>
                   </div>
                </div>
                <!-- Text World -->
                <div class="ae-obs-section">
                   <div class="ae-obs-label">Text World</div>
                   <p id="ae-observation-text" class="ae-card-text ae-caption-text ae-fade-target">
                     The agent sees a partial room view with a door to the front-left.
                   </p>
                </div>
              </div>
            </div>
          </div>

          <div class="ae-column">
            <div class="ae-card ae-truth-card">
              <div class="ae-card-title">Ground Truth</div>
              <div class="ae-card-image">
                <img id="ae-truth-image" class="ae-map-image ae-fade-target" src="" alt="Ground truth map" />
              </div>
            </div>

            <div class="ae-card ae-belief-card">
              <div class="ae-card-title">Agent Belief</div>
              <div class="ae-card-image">
                <img id="ae-belief-image" class="ae-map-image ae-fade-target" src="" alt="Belief map" />
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<style>
  .ae-action-text-enhanced {
    font-size: 1.1rem;
    font-weight: 700;
    color: #4b2a6c;
    background: #f3e8ff;
    padding: 0.4rem 0.8rem;
    border-radius: 8px;
    display: inline-block;
  }
  
  .ae-obs-section {
    margin-bottom: 1rem;
  }
  
  .ae-obs-label {
    font-size: 0.85rem;
    font-weight: 700;
    color: #64748b;
    margin-bottom: 0.5rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    border-bottom: 2px solid #e2e8f0;
    padding-bottom: 0.2rem;
    display: inline-block;
  }

  .ae-observation-image-container {
    min-height: 100px;
    background: #f9fafb;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
  }

  .ae-no-obs-text {
    color: #9ca3af;
    font-style: italic;
    padding: 1rem;
  }

  .ae-fade-target {
    transition: opacity 0.8s ease-in-out;
    opacity: 1;
  }

  .ae-caption-text {
    font-size: 1.25rem !important;
    line-height: 1.6;
    color: #1e293b;
    font-weight: 500;
  }

  .ae-fade-out {
    opacity: 0.2;
  }
</style>

<script>
  const rawBasePath = import.meta.env.BASE_URL ?? '/';
  const normalizedBasePath = rawBasePath.endsWith('/') ? rawBasePath : `${rawBasePath}/`;
  const resolveAssetPath = (path) => {
    if (!path) return '';
    if (/^https?:\/\//.test(path)) return path;
    const trimmed = path.replace(/^\//, '');
    return `${normalizedBasePath}${trimmed}`;
  };

  const steps = [
    {
      observationImage: '',
      observationText: 'No observation.',
      action: 'Initial state',
      beliefImage: '/exploration_example/step0_belief.png',
      truthImage: '/exploration_example/step0_gt.png'
    },
    {
      observationImage: '/exploration_example/step1_observe.png',
      observationText: 'Door: front-left, mid distance.',
      action: 'Turn 90; Observe',
      beliefImage: '/exploration_example/step1_belief.png',
      truthImage: '/exploration_example/step1_gt.png'
    },
    {
      observationImage: '/exploration_example/step2_observe.png',
      observationText: 'Sofa: front, mid distance.',
      action: 'Turn 90; Observe',
      beliefImage: '/exploration_example/step2_belief.png',
      truthImage: '/exploration_example/step2_gt.png'
    },
    {
      observationImage: '/exploration_example/step3_observe.png',
      observationText: 'Fire extinguisher: front, near.',
      action: 'Turn 270; Go to the blue door; Observe',
      beliefImage: '/exploration_example/step3_belief.png',
      truthImage: '/exploration_example/step3_gt.png'
    },
    {
      observationImage: '/exploration_example/step4_observe.png',
      observationText: 'Crate: front-left, mid distance.',
      action: 'Turn 90; Observe',
      beliefImage: '/exploration_example/step4_belief.png',
      truthImage: '/exploration_example/step4_gt.png'
    },
    {
      observationImage: '/exploration_example/step5_observe.png',
      observationText: 'Fire extinguisher: front, mid distance. Door: front-left, mid distance.',
      action: 'Go to the basket; Turn 180; Observe',
      beliefImage: '/exploration_example/step5_belief.png',
      truthImage: '/exploration_example/step5_gt.png'
    },
    {
      observationImage: '',
      observationText: 'No observation.',
      action: 'Terminate',
      beliefImage: '/exploration_example/step5_belief.png',
      truthImage: '/exploration_example/step5_gt.png'
    }
  ];

  let sliderElement = null;
  let isPlaying = false;
  let playInterval = null;
  let to1, to2, to3; // Timeout handles for animation stages

  const updateStep = (index, animate = false) => {
    const step = steps[index];
    if (!step) return;

    // Clear any pending animation timeouts
    clearTimeout(to1);
    clearTimeout(to2);
    clearTimeout(to3);

    const currentStepTop = document.getElementById('ae-current-step-top');
    const currentStepMid = document.getElementById('ae-current-step-mid');
    
    // Always update slider and step counters immediately
    if (currentStepTop) currentStepTop.textContent = String(index);
    if (currentStepMid) currentStepMid.textContent = String(index);
    
    if (sliderElement) {
      sliderElement.value = String(index);
      const percentage = steps.length > 1 ? (index / (steps.length - 1)) * 100 : 0;
      sliderElement.style.background = `linear-gradient(90deg, #7c3aed 0%, #7c3aed ${percentage}%, #e7e3f2 ${percentage}%, #e7e3f2 100%)`;
    }

    if (animate) {
        // Animation Sequence:
        // 1. Fade out Action
        // 2. Update Action & Fade In
        // 3. Wait 0.5s
        // 4. Fade out Rest (Obs, Belief, Truth)
        // 5. Update Rest & Fade In

        const actionText = document.getElementById('ae-action-text');
        
        // Stage 1: Fade out Action
        if (actionText) actionText.classList.add('ae-fade-out');

        to1 = setTimeout(() => {
            // Stage 2: Update Action & Fade In
            if (actionText) {
                actionText.textContent = step.action;
                actionText.classList.remove('ae-fade-out');
            }

            // Stage 3: Wait 0.5s then process the rest
            to2 = setTimeout(() => {
                 const obsImage = document.getElementById('ae-observation-image');
                 const obsText = document.getElementById('ae-observation-text');
                 const truthImage = document.getElementById('ae-truth-image');
                 const beliefImage = document.getElementById('ae-belief-image');
                 
                 const restElements = [obsImage, obsText, truthImage, beliefImage].filter(el => el);
                 
                 // Stage 4: Fade out Rest
                 restElements.forEach(el => el.classList.add('ae-fade-out'));

                 to3 = setTimeout(() => {
                     // Stage 5: Update Rest & Fade In
                     const noObsText = document.getElementById('ae-vision-no-obs');
                     
                     if (obsImage && noObsText) {
                         if (step.observationImage) {
                             obsImage.src = resolveAssetPath(step.observationImage);
                             obsImage.style.display = 'block';
                             noObsText.style.display = 'none';
                         } else {
                             obsImage.style.display = 'none';
                             noObsText.style.display = 'block';
                         }
                     }
                     
                     if (obsText) obsText.textContent = step.observationText || 'No observation.';
                     
                     if (beliefImage) {
                        beliefImage.src = resolveAssetPath(step.beliefImage);
                        const hasBelief = Boolean(step.beliefImage);
                        beliefImage.style.display = hasBelief ? 'block' : 'none';
                        beliefImage.parentElement.style.display = hasBelief ? 'block' : 'none';
                     }
                     
                     if (truthImage) {
                        truthImage.src = resolveAssetPath(step.truthImage);
                        const hasTruth = Boolean(step.truthImage);
                        truthImage.style.display = hasTruth ? 'block' : 'none';
                        truthImage.parentElement.style.display = hasTruth ? 'block' : 'none';
                     }

                     restElements.forEach(el => el.classList.remove('ae-fade-out'));
                 }, 800); // Transition duration (CSS matches this)

            }, 500); // Delay between Action update and Rest update
        }, 800); // Transition duration for Action fade out

    } else {
        // Immediate update without animation
        const observationImage = document.getElementById('ae-observation-image');
        const noObsText = document.getElementById('ae-vision-no-obs');
        const observationText = document.getElementById('ae-observation-text');
        const beliefImage = document.getElementById('ae-belief-image');
        const truthImage = document.getElementById('ae-truth-image');
        const actionText = document.getElementById('ae-action-text');

        if (observationImage && noObsText) {
             if (step.observationImage) {
                 observationImage.src = resolveAssetPath(step.observationImage);
                 observationImage.style.display = 'block';
                 noObsText.style.display = 'none';
             } else {
                 observationImage.style.display = 'none';
                 noObsText.style.display = 'block';
             }
         }
         if (observationText) observationText.textContent = step.observationText || 'No observation.';
         if (actionText) actionText.textContent = step.action;
         if (beliefImage) {
             beliefImage.src = resolveAssetPath(step.beliefImage);
             const hasBelief = Boolean(step.beliefImage);
             beliefImage.style.display = hasBelief ? 'block' : 'none';
             beliefImage.parentElement.style.display = hasBelief ? 'block' : 'none';
         }
         if (truthImage) {
             truthImage.src = resolveAssetPath(step.truthImage);
             const hasTruth = Boolean(step.truthImage);
             truthImage.style.display = hasTruth ? 'block' : 'none';
             truthImage.parentElement.style.display = hasTruth ? 'block' : 'none';
         }
         
         // Ensure opacity is 1
         const fadeElements = document.querySelectorAll('.ae-fade-target');
         fadeElements.forEach(el => el.classList.remove('ae-fade-out'));
    }

    const prevButton = document.getElementById('ae-prev-step');
    const nextButton = document.getElementById('ae-next-step');
    if (prevButton) prevButton.disabled = index === 0;
    if (nextButton) nextButton.disabled = index === steps.length - 1;
  };

  document.addEventListener('DOMContentLoaded', () => {
    const totalStepsTop = document.getElementById('ae-total-steps-top');
    const totalStepsMid = document.getElementById('ae-total-steps-mid');
    const slider = document.getElementById('ae-step-slider');
    const prevButton = document.getElementById('ae-prev-step');
    const nextButton = document.getElementById('ae-next-step');
    const playPauseButton = document.getElementById('ae-play-pause');
    const playIcon = playPauseButton?.querySelector('.ae-play-icon');
    const pauseIcon = playPauseButton?.querySelector('.ae-pause-icon');

    if (totalStepsTop) totalStepsTop.textContent = String(steps.length - 1);
    if (totalStepsMid) totalStepsMid.textContent = String(steps.length - 1);
    if (slider) {
      slider.setAttribute('max', String(steps.length - 1));
      slider.value = '0';
      sliderElement = slider;
    }

    if (slider) {
      slider.addEventListener('input', (event) => {
        const value = Number(event.target.value) || 0;
        updateStep(value, false); // No animation delay on slider drag for responsiveness
      });
    }

    if (prevButton) {
      prevButton.addEventListener('click', () => {
        const current = Number(sliderElement?.value || '0');
        if (current > 0) updateStep(current - 1, true); // Animate on click
      });
    }

    if (nextButton) {
      nextButton.addEventListener('click', () => {
        const current = Number(sliderElement?.value || '0');
        if (current < steps.length - 1) updateStep(current + 1, true); // Animate on click
      });
    }

    const stopPlayback = () => {
      if (playInterval) {
        clearInterval(playInterval);
        playInterval = null;
      }
      isPlaying = false;
      if (playIcon) playIcon.style.display = 'block';
      if (pauseIcon) pauseIcon.style.display = 'none';
    };

    const startPlayback = () => {
      if (isPlaying) return;
      isPlaying = true;
      if (playIcon) playIcon.style.display = 'none';
      if (pauseIcon) pauseIcon.style.display = 'block';
      
      // If we are at the end, restart
      const current = Number(sliderElement?.value || '0');
      if (current === steps.length - 1) {
          updateStep(0, false);
      }

      playInterval = setInterval(() => {
        const current = Number(sliderElement?.value || '0');
        if (current < steps.length - 1) {
          updateStep(current + 1, true); // Animate during playback
        } else {
          stopPlayback();
        }
      }, 4000); // 4 seconds per step (allow for slower transition)
    };

    if (playPauseButton) {
      if (pauseIcon) pauseIcon.style.display = 'none';
      playPauseButton.addEventListener('click', () => {
        if (isPlaying) {
          stopPlayback();
        } else {
          startPlayback();
        }
      });
    }

    updateStep(0, false);
  });
</script>
