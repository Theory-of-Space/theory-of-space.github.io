---
// EvaluationSection.astro - Leaderboard section showing model performance comparisons
const rawBase = import.meta.env.BASE_URL ?? '/';
const normalizedBase = rawBase.endsWith('/') ? rawBase : `${rawBase}/`;
const assetPath = (path: string) => `${normalizedBase}${path.replace(/^\//, '')}`;
---

<section id="leaderboard" class="content-section alt-background">
  <div class="section-container">
    <h2 class="section-title">Evaluation Results</h2>
    <p class="section-description">Performance comparison of different models on <span class="tos-text">Theory of Space</span> (ToS) benchmark. Dark highlighting indicates the best result within each category, light highlighting denotes the second-best.</p>
    
    <div class="leaderboard-container">
      <!-- Main Mode Tabs -->
      <div class="metric-tabs main-tabs">
        <button class="metric-tab active" data-mode="active">Active Exploration</button>
        <button class="metric-tab" data-mode="passive">Passive Understanding</button>
      </div>

      <!-- Environment Toggle -->
      <div class="env-toggle-container">
        <div class="env-toggle">
          <button class="env-btn active" data-env="vision">Vision-based World</button>
          <button class="env-btn" data-env="text">Text-based World</button>
        </div>
      </div>

      <div class="table-controls">
        <div class="model-legend">
          <span class="legend-item">
            <span class="legend-color proprietary-legend"></span>
            Proprietary Models
          </span>
          <span class="legend-item">
            <span class="legend-color open-weight-legend"></span>
            Open-source Models
          </span>
        </div>
      </div>
      
      <div class="table-wrapper">
        <table class="leaderboard-table" id="leaderboardTable">
          <thead id="tableHeader">
            <!-- Header populated by JS -->
          </thead>
          <tbody id="leaderboardBody">
            <!-- Data populated by JS -->
          </tbody>
        </table>
      </div>

<!-- Performance Conclusion (Grid) -->
<section id="key-findings-grid" class="content-section">
  <div class="section-container">
    <div class="results-analysis-single">
      <h3 class="analysis-heading">Performance Conclusion</h3>
      <div class="findings-grid">
        <div class="finding-item">
          <span class="finding-icon">üéØ</span>
          <div class="finding-content">
            <strong>Active exploration is the bottleneck</strong>
            <span class="finding-detail">GPT-5.2: 0.57‚Üí0.46 | GEMINI-3 PRO: 0.60‚Üí0.57 (passive‚Üíactive)</span>
          </div>
        </div>
        <div class="finding-item">
          <span class="finding-icon">üìä</span>
          <div class="finding-content">
            <strong>Substantial modality gap</strong>
            <span class="finding-detail">GPT-5.2: 0.72 text vs 0.46 vision | GEMINI-3 PRO: 0.81 text vs 0.57 vision</span>
          </div>
        </div>
        <div class="finding-item">
          <span class="finding-icon">‚ö°</span>
          <div class="finding-content">
            <strong>Inefficient exploration</strong>
            <span class="finding-detail">Proxy agents: ~9 steps to coverage | Models: far more steps with no gain</span>
          </div>
        </div>
        <div class="finding-item">
          <span class="finding-icon">üîç</span>
          <div class="finding-content">
            <strong>Exploration patterns differ</strong>
            <span class="finding-detail">GPT-5.2: jumps to doors early | GEMINI-3 PRO: rotates first like scout proxy</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<style is:global>
  #leaderboard .section-container {
    max-width: 1000px;
  }

  #leaderboard .leaderboard-container {
    margin: 2rem 0;
  }

  /* Main Tabs */
  #leaderboard .main-tabs {
    display: flex;
    justify-content: center;
    gap: 1rem;
    margin-bottom: 1rem;
  }

  #leaderboard .metric-tab {
    padding: 0.75rem 2rem;
    background: white;
    border: 2px solid #2a2f6c;
    border-radius: 8px;
    color: #2a2f6c;
    font-weight: 600;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  #leaderboard .metric-tab:hover {
    background: #f0f4ff;
  }

  #leaderboard .metric-tab.active {
    background: #2a2f6c;
    color: white;
  }

  /* Environment Toggle */
  #leaderboard .env-toggle-container {
    display: flex;
    justify-content: center;
    margin-bottom: 1.5rem;
  }

  #leaderboard .env-toggle {
    background: #e0e0e0;
    padding: 4px;
    border-radius: 8px;
    display: inline-flex;
  }

  #leaderboard .env-btn {
    padding: 0.5rem 1.5rem;
    border: none;
    border-radius: 6px;
    background: transparent;
    color: #555;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  #leaderboard .env-btn.active {
    background: white;
    color: #2a2f6c;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }

  /* Legend */
  #leaderboard .model-legend {
    display: flex;
    justify-content: center;
    gap: 1.5rem;
    margin-bottom: 1rem;
  }

  #leaderboard .legend-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.9rem;
    color: #555;
  }

  #leaderboard .legend-color {
    width: 16px;
    height: 16px;
    border-radius: 4px;
    border: 1px solid #ddd;
  }

  #leaderboard .proprietary-legend { background-color: #FFF4F0; }
  #leaderboard .open-weight-legend { background-color: #F8F0FF; }

  /* Table */
  #leaderboard .table-wrapper {
    overflow-x: auto;
    border-radius: 12px;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    background: white;
  }

  #leaderboard .leaderboard-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.8rem;
  }

  #leaderboard th {
    padding: 0.6rem 0.4rem;
    text-align: center;
    border: 1px solid #eee;
  }

  #leaderboard .model-header {
    text-align: left;
    padding-left: 1rem;
    background: #f8f9fa;
    font-weight: 700;
    min-width: 180px;
  }

  #leaderboard .group-header {
    font-weight: 700;
    color: #2a2f6c;
  }
  
  #leaderboard .sub-group-header {
    font-weight: 600;
    background: #f0f4ff;
    font-style: italic;
  }

  #leaderboard .col-header {
    font-size: 0.85rem;
    background: #fff;
    vertical-align: bottom;
  }
  
  #leaderboard .col-header span {
    display: inline-block;
    white-space: nowrap;
    line-height: 1.2;
  }

  #leaderboard td {
    padding: 0.6rem 0.4rem;
    text-align: center;
    border: 1px solid #eee;
  }

  #leaderboard .model-name {
    text-align: left;
    padding-left: 1rem;
    font-weight: 600;
    color: #333;
  }

  #leaderboard .proprietary-row { background-color: #FFF4F0; }
  #leaderboard .openweight-row { background-color: #F8F0FF; }

  #leaderboard .best-score {
    background-color: rgba(100, 100, 100, 0.25);
    font-weight: 700;
  }

  #leaderboard .second-best-score {
    background-color: rgba(169, 169, 169, 0.15);
    font-weight: 600;
  }
  
  /* Exp cost column special styling */
  #leaderboard .exp-cost {
    background-color: #fffbf0;
    border-right: 2px solid #eee;
  }
  
  #leaderboard .avg-col {
    background-color: #f8f9fa;
    font-weight: 700;
    border-left: 2px solid #eee;
  }

  /* Key Findings Styles (Grid) */
  #key-findings-grid .section-container {
    max-width: 1300px;
  }
  
  #key-findings-grid .results-analysis-single {
    background: #fff;
    border-radius: 12px;
    padding: 1.5rem 2rem;
    margin: 2rem 0;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
    border: 1px solid #e2e8f0;
  }

  .analysis-heading {
    font-size: 1.3rem;
    font-weight: 700;
    color: #2a2f6c;
    margin: 0 0 1.25rem 0;
    text-align: center;
  }

  #key-findings-grid .findings-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
  }

  #key-findings-grid .finding-item {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 8px;
    border-left: 3px solid #2a2f6c;
  }

  #key-findings-grid .finding-icon {
    font-size: 1.25rem;
    flex-shrink: 0;
  }

  #key-findings-grid .finding-content {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  #key-findings-grid .finding-content strong {
    font-size: 0.95rem;
    color: #1f2a60;
  }

  #key-findings-grid .finding-detail {
    font-size: 0.85rem;
    color: #666;
    line-height: 1.4;
  }

  @media (max-width: 768px) {
    #key-findings-grid .findings-grid {
      grid-template-columns: 1fr;
    }
  }
</style>

<script>
  // Data from Table 1 and Table 2
  type ModelData = {
    type: string;
    name: string;
    exp?: number;
    route: number[];
    survey: number[];
    avg: number;
  };

  const tosData: Record<string, Record<string, ModelData[]>> = {
    active: {
      vision: [
        // Route: [direction, persp.take, perc.dec, act2view, view2act]
        // Survey: [alloc.map, ment.rot, loc2view, view2loc]
        { type: 'proprietary', name: 'GPT-5.2', exp: 17.2, route: [0.400, 0.367, 0.562, 0.438, 0.403], survey: [0.434, 0.597, 0.569, 0.378], avg: 0.460 },
        { type: 'proprietary', name: 'GEMINI-3 PRO', exp: 13.6, route: [0.563, 0.367, 0.682, 0.472, 0.540], survey: [0.635, 0.730, 0.654, 0.522], avg: 0.573 },
        { type: 'proprietary', name: 'CLAUDE-4.5 SONNET', exp: 19.6, route: [0.237, 0.233, 0.187, 0.333, 0.107], survey: [0.374, 0.347, 0.337, 0.509], avg: 0.296 },
        { type: 'openweight', name: 'GLM-4.6V', exp: 15.0, route: [0.158, 0.185, 0.033, 0.140, 0.007], survey: [0.189, 0.080, 0.185, 0.318], avg: 0.144 },
        { type: 'openweight', name: 'QWEN3-VL', exp: 16.3, route: [0.168, 0.233, 0.134, 0.248, 0.057], survey: [0.258, 0.163, 0.215, 0.437], avg: 0.213 }
      ],
      text: [
        { type: 'proprietary', name: 'GPT-5.2', exp: 11.4, route: [0.688, 0.705, 0.803, 0.710, 0.537], survey: [0.779, 0.810, 0.791, 0.660], avg: 0.720 },
        { type: 'proprietary', name: 'GEMINI-3 PRO', exp: 13.5, route: [0.780, 0.792, 0.906, 0.753, 0.763], survey: [0.810, 0.940, 0.833, 0.762], avg: 0.815 },
        { type: 'proprietary', name: 'CLAUDE-4.5 SONNET', exp: 18.7, route: [0.653, 0.653, 0.790, 0.627, 0.517], survey: [0.688, 0.763, 0.570, 0.670], avg: 0.659 },
        { type: 'openweight', name: 'GLM-4.6V', exp: 14.5, route: [0.208, 0.197, 0.127, 0.218, 0.037], survey: [0.139, 0.093, 0.227, 0.262], avg: 0.168 },
        { type: 'openweight', name: 'INTERNVL-3.5', exp: 15.0, route: [0.288, 0.448, 0.260, 0.368, 0.073], survey: [0.310, 0.277, 0.338, 0.389], avg: 0.306 },
        { type: 'openweight', name: 'QWEN3-VL', exp: 14.1, route: [0.323, 0.457, 0.482, 0.333, 0.117], survey: [0.364, 0.347, 0.357, 0.499], avg: 0.368 }
      ]
    },
    passive: {
      vision: [
        // Route: [direction, persp.take, perc.dec, act2view, view2act]
        // Survey: [alloc.map, ment.rot, loc2view, view2loc]
        { type: 'proprietary', name: 'GPT-5.2', route: [0.473, 0.350, 0.639, 0.545, 0.493], survey: [0.648, 0.833, 0.503, 0.656], avg: 0.571 },
        { type: 'proprietary', name: 'GEMINI-3 PRO', route: [0.638, 0.363, 0.575, 0.490, 0.580], survey: [0.672, 0.853, 0.704, 0.570], avg: 0.605 },
        { type: 'proprietary', name: 'CLAUDE-4.5 SONNET', route: [0.473, 0.335, 0.377, 0.408, 0.157], survey: [0.548, 0.583, 0.447, 0.548], avg: 0.431 },
        { type: 'openweight', name: 'GLM-4.6V', route: [0.115, 0.245, 0.047, 0.190, 0.027], survey: [0.229, 0.117, 0.200, 0.336], avg: 0.167 },
        { type: 'openweight', name: 'QWEN3-VL', route: [0.208, 0.283, 0.227, 0.167, 0.047], survey: [0.332, 0.217, 0.273, 0.408], avg: 0.249 }
      ],
      text: [
        { type: 'proprietary', name: 'GPT-5.2', route: [0.845, 0.882, 0.970, 0.890, 0.760], survey: [0.963, 0.983, 0.948, 0.892], avg: 0.904 },
        { type: 'proprietary', name: 'GEMINI-3 PRO', route: [0.827, 0.927, 0.970, 0.875, 0.757], survey: [0.862, 0.913, 0.857, 0.800], avg: 0.865 },
        { type: 'proprietary', name: 'CLAUDE-4.5 SONNET', route: [0.730, 0.807, 0.907, 0.777, 0.590], survey: [0.769, 0.743, 0.592, 0.707], avg: 0.736 },
        { type: 'openweight', name: 'GLM-4.6V', route: [0.223, 0.398, 0.250, 0.253, 0.047], survey: [0.212, 0.090, 0.270, 0.357], avg: 0.234 },
        { type: 'openweight', name: 'INTERNVL-3.5', route: [0.367, 0.678, 0.427, 0.412, 0.087], survey: [0.373, 0.193, 0.387, 0.438], avg: 0.374 },
        { type: 'openweight', name: 'QWEN3-VL', route: [0.408, 0.693, 0.565, 0.500, 0.177], survey: [0.428, 0.403, 0.425, 0.546], avg: 0.456 }
      ]
    }
  };

  // Highlights are now calculated dynamically in renderTable()

  let currentMode = 'active'; // active | passive
  let currentEnv = 'vision'; // vision | text

  document.addEventListener('DOMContentLoaded', function() {
    const modeTabs = document.querySelectorAll('.metric-tab');
    const envBtns = document.querySelectorAll('.env-btn');

    modeTabs.forEach(tab => {
      tab.addEventListener('click', () => {
        modeTabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        const mode = (tab as HTMLElement).dataset.mode;
        if (mode) {
          currentMode = mode;
          renderTable();
        }
      });
    });

    envBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        envBtns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const env = (btn as HTMLElement).dataset.env;
        if (env) {
          currentEnv = env;
          renderTable();
        }
      });
    });

    renderTable();
  });

  function renderTable() {
    const thead = document.getElementById('tableHeader');
    const tbody = document.getElementById('leaderboardBody');
    if (!thead || !tbody) return;

    // 1. Render Header
    let headerHtml = '';
    const hasExp = currentMode === 'active';
    const routeColSpan = 5;
    const surveyColSpan = 4;
    
    // Row 1: Group Headers
    headerHtml += `<tr>`;
    headerHtml += `<th rowspan="3" class="model-header">Methods</th>`;
    if (hasExp) headerHtml += `<th rowspan="3" class="exp-cost">Avg.<br>step</th>`;
    headerHtml += `<th colspan="${routeColSpan}" class="group-header">Route</th>`;
    headerHtml += `<th colspan="${surveyColSpan}" class="group-header">Survey</th>`;
    headerHtml += `<th rowspan="3" class="avg-col">Avg.</th>`;
    headerHtml += `</tr>`;

    // Row 2: Sub-Group Headers (Static/Dynamic)
    headerHtml += `<tr>`;
    headerHtml += `<th colspan="2" class="sub-group-header">Static (S)</th>`;
    headerHtml += `<th colspan="3" class="sub-group-header">Dynamic (D)</th>`;
    headerHtml += `<th class="sub-group-header">Static (S)</th>`;
    headerHtml += `<th colspan="3" class="sub-group-header">Dynamic (D)</th>`;
    headerHtml += `</tr>`;

    // Row 3: Metric Headers (Vertical)
    headerHtml += `<tr>`;
    headerHtml += `<th class="col-header"><span>direction</span></th>`;
    headerHtml += `<th class="col-header"><span>persp.take</span></th>`;
    headerHtml += `<th class="col-header"><span>perc.dec</span></th>`;
    headerHtml += `<th class="col-header"><span>act2view</span></th>`;
    headerHtml += `<th class="col-header"><span>view2act</span></th>`;
    headerHtml += `<th class="col-header"><span>alloc.map</span></th>`;
    headerHtml += `<th class="col-header"><span>ment.rot</span></th>`;
    headerHtml += `<th class="col-header"><span>loc2view</span></th>`;
    headerHtml += `<th class="col-header"><span>view2loc</span></th>`;
    headerHtml += `</tr>`;

    thead.innerHTML = headerHtml;

    // 2. Render Body
    tbody.innerHTML = '';
    const dataList = tosData[currentMode][currentEnv];
    
    // Calculate highlights dynamically
    const calculateHighlights = (data: ModelData[], hasExp: boolean) => {
      const highlights: { [key: string]: number[] } = {};
      const numCols = hasExp ? 1 + 5 + 4 + 1 : 5 + 4 + 1; // exp + route + survey + avg
      
      data.forEach((model) => {
        highlights[model.name] = new Array(numCols).fill(0);
      });
      
      let colIdx = 0;
      
      // Exp cost (lower is better)
      if (hasExp) {
        const expValues = data.map(m => m.exp || 0);
        const bestExp = Math.min(...expValues);
        const uniqueValues = [...new Set(expValues)].sort((a, b) => a - b);
        const secondExp = uniqueValues.length > 1 ? uniqueValues[1] : bestExp;
        
        data.forEach((model) => {
          if (model.exp === bestExp) highlights[model.name][colIdx] = 1;
          else if (model.exp === secondExp) highlights[model.name][colIdx] = 2;
        });
        colIdx++;
      }
      
      // Route tasks (higher is better)
      for (let i = 0; i < 5; i++) {
        const values = data.map(m => m.route[i]);
        const best = Math.max(...values);
        const uniqueValues = [...new Set(values)].sort((a, b) => b - a);
        const second = uniqueValues.length > 1 ? uniqueValues[1] : best;
        
        data.forEach((model) => {
          if (model.route[i] === best) highlights[model.name][colIdx] = 1;
          else if (model.route[i] === second) highlights[model.name][colIdx] = 2;
        });
        colIdx++;
      }
      
      // Survey tasks (higher is better)
      for (let i = 0; i < 4; i++) {
        const values = data.map(m => m.survey[i]);
        const best = Math.max(...values);
        const uniqueValues = [...new Set(values)].sort((a, b) => b - a);
        const second = uniqueValues.length > 1 ? uniqueValues[1] : best;
        
        data.forEach((model) => {
          if (model.survey[i] === best) highlights[model.name][colIdx] = 1;
          else if (model.survey[i] === second) highlights[model.name][colIdx] = 2;
        });
        colIdx++;
      }
      
      // Avg (higher is better)
      const avgValues = data.map(m => m.avg);
      const bestAvg = Math.max(...avgValues);
      const uniqueValues = [...new Set(avgValues)].sort((a, b) => b - a);
      const secondAvg = uniqueValues.length > 1 ? uniqueValues[1] : bestAvg;
      
      data.forEach((model) => {
        if (model.avg === bestAvg) highlights[model.name][colIdx] = 1;
        else if (model.avg === secondAvg) highlights[model.name][colIdx] = 2;
      });
      
      return highlights;
    };
    
    const hlRules = calculateHighlights(dataList, hasExp);

    dataList.forEach((model) => {
      const tr = document.createElement('tr');
      tr.className = model.type === 'proprietary' ? 'proprietary-row' : 'openweight-row';
      
      let html = `<td class="model-name">${model.name}</td>`;
      
      const modelHl = hlRules[model.name] || [];
      let colIdx = 0;

      if (hasExp) {
        const hl = modelHl[colIdx++] || 0;
        const cls = hl === 1 ? 'best-score' : (hl === 2 ? 'second-best-score' : '');
        html += `<td class="exp-cost ${cls}">${(model.exp || 0).toFixed(1)}</td>`;
      }

      // Route
      model.route.forEach((val) => {
        const hl = modelHl[colIdx++] || 0;
        const cls = hl === 1 ? 'best-score' : (hl === 2 ? 'second-best-score' : '');
        html += `<td class="${cls}">${(val * 100).toFixed(1)}</td>`;
      });

      // Survey
      model.survey.forEach((val) => {
        const hl = modelHl[colIdx++] || 0;
        const cls = hl === 1 ? 'best-score' : (hl === 2 ? 'second-best-score' : '');
        html += `<td class="${cls}">${(val * 100).toFixed(1)}</td>`;
      });

      // Avg
      const avgHl = modelHl[colIdx] || 0;
      const avgCls = avgHl === 1 ? 'best-score' : (avgHl === 2 ? 'second-best-score' : '');
      html += `<td class="avg-col ${avgCls}">${(model.avg * 100).toFixed(1)}</td>`;

      tr.innerHTML = html;
      tbody.appendChild(tr);
    });
  }
</script>